name: Stale PR and Issue Management

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:  # Allow manual triggering

# Top-level permissions: least permissive (following PR #781 pattern)
permissions:
  contents: read

jobs:
  stale:
    name: Mark stale issues and PRs
    runs-on: ubuntu-latest
    
    # Job-level permissions: specific needs only
    permissions:
      issues: write
      pull-requests: write
    
    steps:
      - name: Run stale action
        uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          
          # Stale PR Configuration
          days-before-stale: 60
          days-before-close: 14
          
          stale-pr-message: |
            This pull request has been inactive for 60 days and will be marked as stale.
            
            If you're still working on this, please:
            - Update the PR with recent changes
            - Respond to any review comments
            - Rebase on the latest main branch
            
            The PR will be closed in 14 days if there's no activity.
            
            If you need help or have questions, feel free to ask! We appreciate your contribution. üôè
          
          close-pr-message: |
            This pull request was automatically closed due to inactivity.
            
            If you'd like to continue this work, feel free to:
            - Reopen this PR with updates
            - Create a new PR with a fresh rebase
            - Comment here if you need assistance
            
            Thank you for your contribution! ‚ù§Ô∏è
          
          stale-pr-label: 'stale'
          
          # Stale Issue Configuration
          days-before-issue-stale: 90
          days-before-issue-close: 30
          
          stale-issue-message: |
            This issue has been inactive for 90 days and will be marked as stale.
            
            If this is still relevant, please:
            - Provide an update or additional context
            - Confirm you can still reproduce the issue
            - Let us know if you're working on a fix
            
            The issue will be closed in 30 days if there's no activity.
          
          close-issue-message: |
            This issue was automatically closed due to inactivity.
            
            If this is still a problem, feel free to:
            - Reopen with updated information
            - Create a new issue with current details
            
            Thank you for reporting! üôè
          
          stale-issue-label: 'stale'
          
          # Exemptions - Never mark these as stale
          exempt-pr-labels: 'security,critical,in-progress,on-hold,dependencies'
          exempt-issue-labels: 'security,critical,roadmap,pinned,on-hold,help-wanted,good-first-issue'
          
          # Additional Configuration
          operations-per-run: 100
          remove-stale-when-updated: true
          
          # Custom labels for better organization
          ascending: false  # Process newest first
          
          # Prevent closing issues/PRs that have recent comments
          exempt-all-milestones: false
          
          # Enable debug output for troubleshooting
          debug-only: false
