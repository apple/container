name: PR Label Apply

on:
  workflow_run:
    workflows: ["PR Label Analysis"]
    types:
      - completed

permissions:
  contents: read

jobs:
  apply-labels:
    name: Apply labels to PR
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download PR metadata artifact
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          pattern: pr-metadata-*
          merge-multiple: false
        continue-on-error: true
        id: download-artifact
      
      - name: Read PR number
        id: pr-number
        run: |
          METADATA_DIR=$(find . -type d -name "pr-metadata-*" 2>/dev/null | head -n 1)
          
          if [ -z "$METADATA_DIR" ]; then
            echo "No metadata found"
            exit 1
          fi
          
          PR_NUMBER=$(cat "${METADATA_DIR}/pr-number.txt")
          echo "number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "PR Number: ${PR_NUMBER}"
      
      - name: Apply labels using labeler
        uses: actions/labeler@v5
        with:
          pr-number: ${{ steps.pr-number.outputs.number }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true